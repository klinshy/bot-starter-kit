(function(r,s){typeof exports=="object"&&typeof module<"u"?module.exports=s():typeof define=="function"&&define.amd?define(s):(r=typeof globalThis<"u"?globalThis:r||self,r.MyBot=s())})(this,function(){"use strict";return{run:async s=>{const h={};let i;async function d(e,o){try{console.log(`Creating thread for bot: ${e}, user: ${o}`);const t=await fetch(`https://ai.newit.works/api/v1/workspace/${e}/thread/new`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer JM2QWSW-FVYM0C0-KBR1MG5-PE3WSKK","Accept-Encoding":"gzip, deflate, br",Accept:"*/*"},body:JSON.stringify({userId:6})});if(!t.ok)throw new Error(`Failed to create thread: ${t.statusText}`);const n=(await t.json()).thread.slug;return h[o]=n,console.log(`Thread created with ID: ${n} for user ${o}`),n}catch(t){throw console.error("Failed to create thread:",t),t}}async function l(e,o,t){var a;try{console.log(`Handling chat message for bot: ${e}, thread: ${o}, message: ${t}`),WA.chat.startTyping({scope:"bubble"});const n=await fetch(`https://ai.newit.works/api/v1/workspace/${e}/thread/${o}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer JM2QWSW-FVYM0C0-KBR1MG5-PE3WSKK"},body:JSON.stringify({message:t,mode:"chat",userId:6})}).then(p=>p.json()),c=(a=n.choices[0])==null?void 0:a.message.content;if(!c)throw new Error("Custom AI returned no response: "+JSON.stringify(n));console.log("Custom AI response:",c),WA.chat.sendChatMessage(c,{scope:"bubble"}),WA.chat.stopTyping({scope:"bubble"})}catch(n){console.error("Failed to handle chat message:",n)}}WA.onInit().then(async()=>{console.log("COUCOU",s),i=await WA.player.name,WA.player.proximityMeeting.onParticipantJoin().subscribe(async e=>{console.log(`User ${e.name} with UUID ${e.uuid} joined the proximity meeting.`);let o=h[e.uuid];o?console.log(`Found existing thread ${o} for user ${e.uuid}.`):(console.log(`No existing thread for user ${e.uuid}, creating new thread.`),o=await d(i,e.uuid)),WA.chat.onChatMessage(async(t,a)=>{if(!a.author){console.log("Received message with no author, ignoring.");return}console.log(`Received message from ${a.author.name}: ${t}`),await l(i,o,t)},{scope:"bubble"})})})}}});
