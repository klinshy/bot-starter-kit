(function(i,n){typeof exports=="object"&&typeof module<"u"?module.exports=n():typeof define=="function"&&define.amd?define(n):(i=typeof globalThis<"u"?globalThis:i||self,i.MyBot=n())})(this,function(){"use strict";return{run:async n=>{await WA.onInit(),await WA.players.configureTracking({players:!0});const r={};let s;async function c(e){try{console.log(`Creating thread for bot: ${e}`);const o=await fetch(`https://ai.newit.works/api/v1/workspace/${e}/thread/new`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer JM2QWSW-FVYM0C0-KBR1MG5-PE3WSKK","Accept-Encoding":"gzip, deflate, br",Accept:"*/*"},body:JSON.stringify({userId:6})});if(!o.ok)throw new Error(`Failed to create thread: ${o.statusText}`);const a=(await o.json()).thread.slug;return console.log(`Thread created with ID: ${a}`),a}catch(o){throw console.error("Failed to create thread:",o),o}}async function l(e,o){try{console.log(`Handling chat message for bot: ${s}, thread: ${e}, message: ${o}`),WA.chat.startTyping({scope:"bubble"});const t=await fetch(`https://ai.newit.works/api/v1/workspace/${s}/thread/${e}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer JM2QWSW-FVYM0C0-KBR1MG5-PE3WSKK","Accept-Encoding":"gzip, deflate, br",Accept:"*/*"},body:JSON.stringify({message:o,mode:"chat",userId:6})}).then(u=>u.json()),a=t.textResponse;if(!a)throw new Error("Custom AI returned no text response: "+JSON.stringify(t));console.log("Custom AI text response:",a),WA.chat.sendChatMessage(a,{scope:"bubble"}),WA.chat.stopTyping({scope:"bubble"}),console.log("Chat message handled successfully.")}catch(t){console.error("Failed to handle chat message:",t)}}async function d(){try{console.log("Initializing bot with metadata:",n),s=WA.room.hashParameters.model||"kos",console.log(s+" is ready!"),console.log("Bot initialized successfully.")}catch(e){console.error("Failed to initialize bot:",e)}}async function h(e){try{console.log(`User ${e.name} with UUID ${e.uuid} joined the proximity meeting.`);let o=r[e.uuid];o?console.log(`Found existing thread ${o} for user ${e.uuid}.`):(console.log(`No existing thread for user ${e.uuid}, creating new thread.`),o=await c(s),r[e.uuid]=o),console.log("Participant join handled successfully.")}catch(o){console.error("Failed to handle participant join:",o)}}try{await d(),WA.player.proximityMeeting.onJoin().subscribe(async e=>{await h(e)}),WA.chat.onChatMessage(async(e,o)=>{if(!o.author){console.log("Received message with no author, ignoring.");return}console.log(`Received message from ${o.author.name}: ${e}`);const t=r[o.author.uuid];t?await l(t,e):console.log(`No thread found for user ${o.author.uuid}`)},{scope:"bubble"}),console.log("Bot initialized!")}catch(e){console.error("Failed to run bot:",e)}}}});
